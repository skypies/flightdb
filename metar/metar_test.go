package metar

// go test -v github.com/skypies/flightdb2/metar

import (
	"fmt"
	"testing"
	"time"
)

var(
	rawNOAA = `No errors
No warnings
8 ms
data source=metars
34 results
raw_text,station_id,observation_time,latitude,longitude,temp_c,dewpoint_c,wind_dir_degrees,wind_speed_kt,wind_gust_kt,visibility_statute_mi,altim_in_hg,sea_level_pressure_mb,corrected,auto,auto_station,maintenance_indicator_on,no_signal,lightning_sensor_off,freezing_rain_sensor_off,present_weather_sensor_off,wx_string,sky_cover,cloud_base_ft_agl,sky_cover,cloud_base_ft_agl,sky_cover,cloud_base_ft_agl,sky_cover,cloud_base_ft_agl,flight_category,three_hr_pressure_tendency_mb,maxT_c,minT_c,maxT24hr_c,minT24hr_c,precip_in,pcp3hr_in,pcp6hr_in,pcp24hr_in,snow_in,vert_vis_ft,metar_type,elevation_m
KSFO 302056Z 29008KT 10SM FEW021 SCT120 BKN180 14/06 A3005 RMK AO2 SLP177 T01390061 58006 $,KSFO,2016-01-30T20:56:00Z,37.62,-122.37,13.9,6.1,290,8,,10.0,30.050198,1017.7,,,TRUE,TRUE,,,,,,FEW,2100,SCT,12000,BKN,18000,,,VFR,-0.6,,,,,,,,,,,METAR,3.0
KSFO 301956Z 29013KT 10SM FEW021 SCT120 BKN180 14/07 A3009 RMK AO2 SLP190 T01390067 $,KSFO,2016-01-30T19:56:00Z,37.62,-122.37,13.9,6.7,290,13,,10.0,30.088583,1019.0,,,TRUE,TRUE,,,,,,FEW,2100,SCT,12000,BKN,18000,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 301856Z 29013KT 10SM FEW021 SCT140 BKN200 13/07 A3009 RMK AO2 SLP188 T01330067 $,KSFO,2016-01-30T18:56:00Z,37.62,-122.37,13.3,6.7,290,13,,10.0,30.088583,1018.8,,,TRUE,TRUE,,,,,,FEW,2100,SCT,14000,BKN,20000,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 301756Z 31009KT 10SM FEW021 SCT120 BKN150 13/07 A3007 RMK AO2 SLP183 T01280072 10128 20106 58006 $,KSFO,2016-01-30T17:56:00Z,37.62,-122.37,12.8,7.2,310,9,,10.0,30.070866,1018.3,,,TRUE,TRUE,,,,,,FEW,2100,SCT,12000,BKN,15000,,,VFR,-0.6,12.8,10.6,,,,,,,,,METAR,3.0
KSFO 301656Z 29009KT 10SM FEW021 SCT120 BKN150 12/07 A3009 RMK AO2 SLP190 T01170072 $,KSFO,2016-01-30T16:56:00Z,37.62,-122.37,11.7,7.2,290,9,,10.0,30.088583,1019.0,,,TRUE,TRUE,,,,,,FEW,2100,SCT,12000,BKN,15000,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 301556Z 29009KT 10SM FEW021 SCT060 BKN120 11/07 A3008 RMK AO2 SLP186 T01060072 $,KSFO,2016-01-30T15:56:00Z,37.62,-122.37,10.6,7.2,290,9,,10.0,30.079725,1018.6,,,TRUE,TRUE,,,,,,FEW,2100,SCT,6000,BKN,12000,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 301456Z 31012KT 10SM FEW020 BKN065 BKN100 11/08 A3009 RMK AO2 SLP189 T01110078 53009 $,KSFO,2016-01-30T14:56:00Z,37.62,-122.37,11.1,7.8,310,12,,10.0,30.088583,1018.9,,,TRUE,TRUE,,,,,,FEW,2000,BKN,6500,BKN,10000,,,VFR,0.9,,,,,,,,,,,METAR,3.0
KSFO 301356Z 28011KT 10SM FEW050 BKN100 11/07 A3004 RMK AO2 SLP174 T01060072 $,KSFO,2016-01-30T13:56:00Z,37.62,-122.37,10.6,7.2,280,11,,10.0,30.041338,1017.4,,,TRUE,TRUE,,,,,,FEW,5000,BKN,10000,,,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 301256Z 28010KT 10SM BKN055 11/08 A3003 RMK AO2 PRESFR SLP170 T01110083 $,KSFO,2016-01-30T12:56:00Z,37.62,-122.37,11.1,8.3,280,10,,10.0,30.029528,1017.0,,,TRUE,TRUE,,,,,,BKN,5500,,,,,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 301156Z 27012KT 10SM FEW045 OVC070 11/08 A3006 RMK AO2 PRESRR SLP180 60000 70007 T01110083 10122 20111 51014 $,KSFO,2016-01-30T11:56:00Z,37.62,-122.37,11.1,8.3,270,12,,10.0,30.059055,1018.0,,,TRUE,TRUE,,,,,,FEW,4500,OVC,7000,,,,,VFR,1.4,12.2,11.1,,,,,0.005,0.07,,,METAR,3.0
KSFO 301104Z 30009KT 10SM SCT015 OVC040 11/09 A3007 RMK AO2 T01110089 $,KSFO,2016-01-30T11:04:00Z,37.62,-122.37,11.1,8.9,300,9,,10.0,30.070866,,,,TRUE,TRUE,,,,,,SCT,1500,OVC,4000,,,,,VFR,,,,,,,,,,,,SPECI,3.0
KSFO 301056Z 29008KT 10SM BKN015 OVC039 12/09 A3006 RMK AO2 SLP180 T01170089 $,KSFO,2016-01-30T10:56:00Z,37.62,-122.37,11.7,8.9,290,8,,10.0,30.059055,1018.0,,,TRUE,TRUE,,,,,,BKN,1500,OVC,3900,,,,,MVFR,,,,,,,,,,,,METAR,3.0
KSFO 301049Z 29009KT 10SM BKN015 OVC039 12/09 A3006 RMK AO2 T01170089 $,KSFO,2016-01-30T10:49:00Z,37.62,-122.37,11.7,8.9,290,9,,10.0,30.059055,,,,TRUE,TRUE,,,,,,BKN,1500,OVC,3900,,,,,MVFR,,,,,,,,,,,,METAR,3.0
KSFO 301038Z 29008KT 10SM BKN014 OVC037 12/09 A3007 RMK AO2 T01170089 $,KSFO,2016-01-30T10:38:00Z,37.62,-122.37,11.7,8.9,290,8,,10.0,30.070866,,,,TRUE,TRUE,,,,,,BKN,1400,OVC,3700,,,,,MVFR,,,,,,,,,,,,METAR,3.0
KSFO 300956Z 28011KT 10SM SCT031 OVC039 12/09 A3004 RMK AO2 SLP173 T01170089 $,KSFO,2016-01-30T09:56:00Z,37.62,-122.37,11.7,8.9,280,11,,10.0,30.041338,1017.3,,,TRUE,TRUE,,,,,,SCT,3100,OVC,3900,,,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 300928Z 28013KT 10SM SCT012 BKN037 OVC100 12/09 A3003 RMK AO2 T01170089 $,KSFO,2016-01-30T09:28:00Z,37.62,-122.37,11.7,8.9,280,13,,10.0,30.029528,,,,TRUE,TRUE,,,,,,SCT,1200,BKN,3700,OVC,10000,,,VFR,,,,,,,,,,,,METAR,3.0
KSFO 300903Z 29014KT 10SM OVC014 12/10 A3003 RMK AO2 T01170100 $,KSFO,2016-01-30T09:03:00Z,37.62,-122.37,11.7,10.0,290,14,,10.0,30.029528,,,,TRUE,TRUE,,,,,,OVC,1400,,,,,,,MVFR,,,,,,,,,,,,METAR,3.0
KSFO 300856Z 28012KT 10SM SCT009 OVC080 12/10 A3002 RMK AO2 RAE08 SLP166 P0000 60000 T01220100 58013 $,KSFO,2016-01-30T08:56:00Z,37.62,-122.37,12.2,10.0,280,12,,10.0,30.02067,1016.6,,,TRUE,TRUE,,,,,,SCT,900,OVC,8000,,,,,VFR,-1.3,,,,,0.005,0.005,,,,,METAR,3.0
KSFO 300814Z 27008KT 10SM SCT009 OVC080 12/10 A3003 RMK AO2 RAE08 P0000 T01170100 $,KSFO,2016-01-30T08:14:00Z,37.62,-122.37,11.7,10.0,270,8,,10.0,30.029528,,,,TRUE,TRUE,,,,,,SCT,900,OVC,8000,,,,,VFR,,,,,,0.005,,,,,,SPECI,3.0
KSFO 300756Z 24006KT 10SM -RA FEW012 SCT015 OVC036 12/11 A3003 RMK AO2 SLP170 P0000 T01170106 401610117 $,KSFO,2016-01-30T07:56:00Z,37.62,-122.37,11.7,10.6,240,6,,10.0,30.029528,1017.0,,,TRUE,TRUE,,,,,-RA,FEW,1200,SCT,1500,OVC,3600,,,VFR,,,,16.1,11.7,0.005,,,,,,METAR,3.0
KSFO 300656Z 27010KT 9SM -RA FEW012 SCT015 OVC036 12/11 A3005 RMK AO2 SLP177 P0000 T01220106 $,KSFO,2016-01-30T06:56:00Z,37.62,-122.37,12.2,10.6,270,10,,9.0,30.050198,1017.7,,,TRUE,TRUE,,,,,-RA,FEW,1200,SCT,1500,OVC,3600,,,VFR,,,,,,0.005,,,,,,METAR,3.0
KSFO 300556Z 28013KT 5SM -RA BR FEW005 SCT024 OVC031 12/11 A3006 RMK AO2 SLP179 P0002 60006 T01220111 10156 20122 51005 $,KSFO,2016-01-30T05:56:00Z,37.62,-122.37,12.2,11.1,280,13,,5.0,30.059055,1017.9,,,TRUE,TRUE,,,,,-RA BR,FEW,500,SCT,2400,OVC,3100,,,MVFR,0.5,15.6,12.2,,,0.02,,0.06,,,,METAR,3.0
KSFO 300533Z 29011KT 8SM -RA FEW005 BKN022 OVC031 12/11 A3005 RMK AO2 P0002 T01220111,KSFO,2016-01-30T05:33:00Z,37.62,-122.37,12.2,11.1,290,11,,8.0,30.050198,,,,TRUE,,,,,,-RA,FEW,500,BKN,2200,OVC,3100,,,MVFR,,,,,,0.02,,,,,,METAR,3.0
KSFO 300507Z 28011KT 2 1/2SM -RA BR SCT005 OVC012 13/12 A3006 RMK AO2 P0000 T01280117,KSFO,2016-01-30T05:07:00Z,37.62,-122.37,12.8,11.7,280,11,,2.5,30.059055,,,,TRUE,,,,,,-RA BR,SCT,500,OVC,1200,,,,,IFR,,,,,,0.005,,,,,,SPECI,3.0
KSFO 300456Z 29011KT 4SM -RA BR SCT006 BKN012 OVC015 13/12 A3005 RMK AO2 SLP177 P0002 T01280117,KSFO,2016-01-30T04:56:00Z,37.62,-122.37,12.8,11.7,290,11,,4.0,30.050198,1017.7,,,TRUE,,,,,,-RA BR,SCT,600,BKN,1200,OVC,1500,,,MVFR,,,,,,0.02,,,,,,METAR,3.0
KSFO 300435Z 29008KT 5SM -RA BR SCT006 BKN012 OVC016 13/12 A3004 RMK AO2 P0001 T01280117,KSFO,2016-01-30T04:35:00Z,37.62,-122.37,12.8,11.7,290,8,,5.0,30.041338,,,,TRUE,,,,,,-RA BR,SCT,600,BKN,1200,OVC,1600,,,MVFR,,,,,,0.01,,,,,,METAR,3.0
KSFO 300356Z 29008KT 4SM -RA BR FEW006 SCT010 OVC017 13/12 A3005 RMK AO2 CIG 011 RWY L10 SLP176 P0001 T01280117,KSFO,2016-01-30T03:56:00Z,37.62,-122.37,12.8,11.7,290,8,,4.0,30.050198,1017.6,,,TRUE,,,,,,-RA BR,FEW,600,SCT,1000,OVC,1700,,,MVFR,,,,,,0.01,,,,,,METAR,3.0
KSFO 300336Z 30013KT 4SM -RA BR SCT011 BKN014 OVC028 13/12 A3005 RMK AO2 P0000 T01330117,KSFO,2016-01-30T03:36:00Z,37.62,-122.37,13.3,11.7,300,13,,4.0,30.050198,,,,TRUE,,,,,,-RA BR,SCT,1100,BKN,1400,OVC,2800,,,MVFR,,,,,,0.005,,,,,,METAR,3.0
KSFO 300256Z 21006KT 9SM -RA FEW013 BKN028 OVC039 15/13 A3004 RMK AO2 SLP173 P0001 60001 T01500128 56007,KSFO,2016-01-30T02:56:00Z,37.62,-122.37,15.0,12.8,210,6,,9.0,30.041338,1017.3,,,TRUE,,,,,,-RA,FEW,1300,BKN,2800,OVC,3900,,,MVFR,-0.7,,,,,0.01,0.01,,,,,METAR,3.0
KSFO 300156Z 19005KT 6SM -RA BR SCT014 BKN019 OVC025 15/13 A3005 RMK AO2 SLP175 P0000 T01500133,KSFO,2016-01-30T01:56:00Z,37.62,-122.37,15.0,13.3,190,5,,6.0,30.050198,1017.5,,,TRUE,,,,,,-RA BR,SCT,1400,BKN,1900,OVC,2500,,,MVFR,,,,,,0.005,,,,,,METAR,3.0
KSFO 300056Z 18011KT 10SM -RA SCT013 BKN020 OVC030 15/13 A3005 RMK AO2 SLP175 P0000 T01500128,KSFO,2016-01-30T00:56:00Z,37.62,-122.37,15.0,12.8,180,11,,10.0,30.050198,1017.5,,,TRUE,,,,,,-RA,SCT,1300,BKN,2000,OVC,3000,,,MVFR,,,,,,0.005,,,,,,METAR,3.0
KSFO 292356Z 19006KT 4SM -RA BR SCT014 BKN018 OVC022 15/14 A3007 RMK AO2 SLP181 P0001 60001 T01500139 10161 20150 55016,KSFO,2016-01-29T23:56:00Z,37.62,-122.37,15.0,13.9,190,6,,4.0,30.070866,1018.1,,,TRUE,,,,,,-RA BR,SCT,1400,BKN,1800,OVC,2200,,,MVFR,-1.6,16.1,15.0,,,0.01,,0.01,,,,METAR,3.0
KSFO 292256Z 17006G15KT 10SM -RA FEW012 BKN016 OVC031 16/14 A3006 RMK AO2 SLP179 P0000 T01560139,KSFO,2016-01-29T22:56:00Z,37.62,-122.37,15.6,13.9,170,6,15,10.0,30.059055,1017.9,,,TRUE,,,,,,-RA,FEW,1200,BKN,1600,OVC,3100,,,MVFR,,,,,,0.005,,,,,,METAR,3.0
KSFO 292156Z 18011KT 3SM -RA BR FEW003 SCT014 OVC021 15/13 A3008 RMK AO2 RAB55 SLP187 P0000 T01500133,KSFO,2016-01-29T21:56:00Z,37.62,-122.37,15.0,13.3,180,11,,3.0,30.079725,1018.7,,,TRUE,,,,,,-RA BR,FEW,300,SCT,1400,OVC,2100,,,MVFR,,,,,,0.005,,,,,,METAR,3.0
`
)

func TestParseNOAA(t *testing.T) {
	reports,err := parseNOAA(rawNOAA)
	if err != nil {
		t.Errorf("fetch failed: %v", err)
	}

	//for _,l := range reports { fmt.Printf(" %s\n", l) }
	if len(reports) != 34 {
		t.Errorf("expected 25 entries, got %d", len(reports))
	}
}

func TestLookup(t *testing.T) {
	reports,_ := parseNOAA(rawNOAA)
	a := assembleNOAA(reports)
	//fmt.Printf("%s\n====\n", a)

	// 58m past the hour, should return the report for that hour's slot
	t1,_ := time.Parse("2006-01-02T15:04:05Z", "2016-01-29T22:58:00Z")
	if r := a.Lookup(t1); r == nil {
		t.Errorf("Lookup of %s failed", t1)
	} else if t1.Hour() != r.Hour() {
		t.Errorf("Lookup of %s had wrong hour (%s)", t1, r)
	} else {
		fmt.Printf("Yeah! %s --> %s\n", t1, r)
	}

	// At 50m past the hour, should get previous hour's report (56m is in the 'future')
	t2,_ := time.Parse("2006-01-02T15:04:05Z", "2016-01-29T22:50:00Z")
	if r := a.Lookup(t2); r == nil {
		t.Errorf("Lookup of %s failed", t2)
	} else if t2.Hour() != r.Hour()+1 {
		t.Errorf("Lookup of %s had wrong hour (%s)", t2, r)
	} else {
		fmt.Printf("Yeah! %s --> %s\n", t2, r)
	}

	// No data from this early in the day
	t3,_ := time.Parse("2006-01-02T15:04:05Z", "2016-01-29T12:50:00Z")
	if r := a.Lookup(t3); r != nil {
		t.Errorf("Lookup of %s succeeded", t3)
	}

	// No data from some other day
	t4,_ := time.Parse("2006-01-02T15:04:05Z", "2016-01-01T12:50:00Z")
	if r := a.Lookup(t4); r != nil {
		t.Errorf("Lookup of %s succeeded", t4)
	}
}


func TestFetchNOAA(t *testing.T) {
	now := time.Now().AddDate(0,0,-2)
	a,err := fetchArchiveFromNOAA(nil, "KSFO", now.AddDate(0,0,-1), now)
	if err != nil || a == nil {
		t.Errorf("fetch failed: %v", err)
	}
	fmt.Printf("%s\nWahay!\n", a)
}
